/**
 * @file node_modules/features/memberFeed.js
 * @description 멤버 입퇴장 시의 행동
 */




/* =================================== 상수/전역 =================================== */


const _SCRIPT_NAME = "features/memberFeed.js";
const { Logger } = require("shared/logger");
// const { getUserNameWithId } = require("hydrator"); // DB에 저장된 유저 이름 조회




/* =================================== 유틸/헬퍼 =================================== */


/**
 * @description 안전 닉네임 추출
 * @param {object} feed
 * @returns {string|null}
 */
function _extractJoinName(feed) {
    try {
        return (
            feed?.msg?.members?.[0]?.nickName ||
            feed?.json?.message?.members?.[0]?.nickName ||
            feed?.sender || null
        );
    } catch (e) {
        Logger.e(_SCRIPT_NAME, e);
        return null;
    }
}
/**
 * @description 퇴장자 닉네임 추출
 * @param {object} feed
 * @returns {string|null}
 */
function _extractLeaveName(feed) {
    try {
        return (
            feed?.msg?.member?.nickName ||
            feed?.json?.message?.member?.nickName ||
            null
        );
    } catch (e) {
        Logger.e(_SCRIPT_NAME, e);
        return null;
    }
}
/**
 * @description 강퇴 정보 추출
 * @param {object} feed
 * @returns {{kickerId?:string, kickerName?:string, kickedId?:string, kickedName?:string}}
 */
function _extractKickInfo(feed) {
    try {
        const kickerId = feed?.json?.user_id || null;
        const kickerName = feed?.sender || null;
        const kickedId =
            feed?.msg?.member?.userId ||
            feed?.json?.message?.member?.userId ||
            null;
        const kickedName =
            feed?.msg?.member?.nickName ||
            feed?.json?.message?.member?.nickName ||
            null;
        return { kickerId, kickerName, kickedId, kickedName };
    } catch (e) {
        Logger.e(_SCRIPT_NAME, e);
        return {};
    }
}




/* =================================== 메인 로직 =================================== */


/** @description 기능 등록 엔트리 */
function register({ registerFeed }) {
    // 입장: feedType = 4
    registerFeed(4, (feed) => {
        try {
            const name = _extractJoinName(feed);
            if (!name) return;
            feed.send(`${name} 님, 환영합니다!`);
        } catch (e) {
            Logger.e(_SCRIPT_NAME, e);
        }
    }, 100);

    // 퇴장: feedType = 2
    registerFeed(2, (feed) => {
        try {
            const name = _extractLeaveName(feed);
            if (!name) return;
            feed.send(`${name} 님이 퇴장했습니다.`);
        } catch (e) {
            Logger.e(_SCRIPT_NAME, e);
        }
    }, 100);

    // 강퇴: feedType = 6
    registerFeed(6, (feed) => {
        try {
            const { kickerName, kickedName } = _extractKickInfo(feed);
            if (!kickedName) return;
            feed.send(`${kickerName}님이 ${kickedName}님을 강퇴했습니다.`);
        } catch (e) {
            Logger.e(_SCRIPT_NAME, e);
        }
    }, 100);
}

module.exports = { register };