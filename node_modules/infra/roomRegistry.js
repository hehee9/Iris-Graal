/**
 * @file node_modules/infra/roomRegistry.js
 * @description 채팅방 별 특이사항 등 정보 기록
 */


/** @typedef {import("shared/types").Room} Room */
/** @typedef {Object.<string, Room>} RoomMap */


const { PATH_CHAT_ROOM_CACHE } = require("shared/config");
/** @type RoomMap */
let CHAT_ROOM_CACHE = FileStream.readJson(PATH_CHAT_ROOM_CACHE) || {};


/**
 * @description 채팅방 캐시 데이터 저장
 * - 동시성에 주의
 * @param {string|bigint} channelId 채널 Id
 * @param {Room} newRoomData 새 방 데이터
 */
function addRoomInfo(channelId, newRoomData) {
    if (!channelId || !newRoomData || typeof newRoomData !== "object") return;
    const key = String(channelId);
    newRoomData.channelId = key; // stringify용
    CHAT_ROOM_CACHE[key] = newRoomData;
    FileStream.saveJson(PATH_CHAT_ROOM_CACHE, CHAT_ROOM_CACHE);
}


/**
 * @description 빠른 캐시 조회
 * @param {string|bigint} channelId
 * @param {string} [name]
 * @returns {Room}
 */
function getRoomInfo(channelId, name) {
    const key = String(channelId);
    if (CHAT_ROOM_CACHE[key]) return CHAT_ROOM_CACHE[key];

    // 기본값
    return {
        channelId: String(channelId),
        name,
        isOpenChat: true,
        isGroupChat: true,
        _needsUpdate: true
    }
}


module.exports = { getRoomInfo, addRoomInfo };